#!/usr/bin/env bash
#
# Copyright (c) 2019 10x Genomics, Inc. All rights reserved.
#
# Run SC_ATAC_REANALYZER_CS with mrp.
#

source $TENX_SCRIPTDIR/common/_includes
source $TENX_SCRIPTDIR/common/_includes_aggr_reanalyze

DOCOPT_SPEC="$(cat <<EOF
'$TENX_PRODUCT $TENX_SUBCMD' performs secondary analysis \(dimensionality
reduction, clustering and differential expression\) on a feature-barcode 
matrix generated by the '$TENX_PRODUCT count' or '$TENX_PRODUCT aggr'
pipelines.

The analysis takes parameter settings from a CSV file. Please see the following
URL for details on the CSV format:
support.10xgenomics.com/single-cell-atac/software

The commands below should be preceded by '$TENX_PRODUCT':

Usage:
    $TENX_SUBCMD
        --id=ID
	--peaks=PEAKS_BED
	--fragments=FRAGMENTS_TSV_GZ
	--reference=PATH
        [options]
    $TENX_SUBCMD <run_id> <mro> [options]
    $TENX_SUBCMD -h | --help | --version

Arguments:
    id          A unique run id, used to name output folder [a-zA-Z0-9_-]+.
    peaks       A list of peaks identified as genomic regions enriched for
    		    accessibility
    fragments   A block-gzipped TSV file of fragments present in the library.
    		    An tabix (.tbi) index file of the same name is expected to
		    be present in the same directory, otherwise specify using
		    optional argument --index
    reference   Path of folder containing a 10x-compatible reference.

Options:
# Sample specification
    $DOCOPT_OPTIONS_SAMPLE_INFO
# Analysis
    $DOCOPT_OPTIONS_REANALYZE
# Martian Runtime
    $DOCOPT_OPTIONS_MRP_CLUSTER
EOF
)"

function implement_process_options {
    process_options_cratac_reanalyze
    process_options_reference
}

function implement_generate_sample_defs {
    : # noop
}

function implement_generate_mro {
    cat <<EOF > $mro
@include "sc_atac_reanalyzer_cs.mro"

call SC_ATAC_REANALYZER_CS(
    sample_id = $sample_id,
    sample_desc = $sample_desc,
    reference_path = $reference_path,
    parameters = $params,
    aggregation_csv = $aggregation_csv,
    cell_barcodes = $barcodes,
    peaks = $peaks,
    force_cells = $force_cells,
    fragments = $frags,
    fragments_index = $frags_index,
)
EOF
}

source $TENX_SCRIPTDIR/../tenkit/bin/common/_subcmd_mrp
